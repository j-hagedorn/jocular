---
title: "Fantasy Basketball"
output: html_document
date: "2022-09-18"
---

```{r setup, include=FALSE}
library(tidyverse);library(plotly); library(paletteer)
knitr::opts_chunk$set(warning = F, message = F, echo = F)
# games <- arrow::read_parquet("data/games.parquet")
player_season <- arrow::read_parquet("../data/player_season.parquet")
# df_nba_player_dict <- arrow::read_parquet("data/df_nba_player_dict.parquet")
```

# Preparation 

- Filter players from each season with > 30 games
- Include more than 1 year? (at least Include max year per player)
- Filter out folks with < 15 minutes/game (*e.g. Nicolas Batum, Frank Kaminsky, Isaiah Roby*)

```{r}
df <-
  player_season %>%
  select(
    yearSeason, idPlayerNBA, namePlayer, agePlayer, 
    slugPosition, slugTeamBREF, where(is.numeric)
  ) %>%
  select(
    -countTeamsPlayerSeason,
    -countTeamsPlayerSeasonPerGame,
    -countTeamsPlayerSeasonTotals,-minutes,
    -ends_with("Totals"),-starts_with("url")
  ) %>%
  rename(
    season = yearSeason, player_id = idPlayerNBA, player_name = namePlayer,
    player_age = agePlayer, player_pos = slugPosition, player_team = slugTeamBREF
  ) %>%
  select(
    season,starts_with("player_"), countGames, countGamesStarted, minutesPerGame,
    trbPerGame, astPerGame, ptsPerGame, fg3mPerGame, stlPerGame, 
    blkPerGame, pctFG, pctFT, tovPerGame
  ) %>%
  filter(countGames >= 30) %>%
  group_by(player_id) %>%
  filter(season == max(season)) %>%
  ungroup() %>%
  filter(season %in% c(2022, 2023)) %>%
  mutate_at(vars(trbPerGame:pctFG), list(rank = percent_rank)) %>%
  # rank turnovers inversely
  mutate(tovPerGame_rank = 1 - percent_rank(tovPerGame)) %>%
  rowwise() %>%
  mutate(mean_rank = mean(c_across(ends_with("_rank")))) %>%
  ungroup() %>%
  arrange(mean_rank) %>%
  select(-season) 
```

```{r eval=FALSE, include=FALSE}

p <-
  df %>%
  select(player_id,player_name,player_pos,mean_rank,countGames) %>%
  separate(player_pos, c("pos1","pos2","pos3"),"-") %>%
  pivot_longer(pos1:pos3,names_to = "field",values_to = "pos") %>%
  filter(!is.na(pos)) %>%
  filter(countGames >=30) %>%
  select(-field) %>%
  group_by(pos) %>%
  slice_max(mean_rank, n = 10) %>%
  ggplot(
    aes(x = fct_reorder(player_name,mean_rank,.desc = T), y = mean_rank)
  ) +
  geom_col(aes(fill = countGames)) +
  facet_grid(cols = vars(pos), scales = "free") +
  labs(x = "") +
  scale_x_discrete(guide = guide_axis(angle = 90)) +
  theme_minimal()

ggplotly(p)

```

Maybe add serpentine ordering

```{r eval=FALSE, include=FALSE}

teams <-
  df %>%
  mutate(team = rep(1:12, each = 1, length.out = nrow(.))) %>%
  group_by(team) %>%
  # Select top n players per team
  slice_max(mean_rank, n = 13) 


```

```{r eval=FALSE, include=FALSE}

team_sum <-
  teams %>%
  group_by(team) %>%
  summarize_at(vars(trbPerGame:tovPerGame), list(~sum(.))) %>%
  pivot_longer(trbPerGame:tovPerGame,names_to = "category") %>% 
  group_by(category) %>%
  mutate(
    rank = cume_dist(value),
    n_teams = n_distinct(team),
    n_beats = rank * n_teams
  )

team_sum  %>%
  ggplot(aes(x = category, y = n_beats)) +
  facet_grid(vars(team), scales = "free") +
  geom_col() +
  theme_minimal()

```

incorporate mins_game and games_played
for each round, sort on the stats and positions needed by the team picking
strategies (a) dominate minimum N of categories to assure wins, (b) balance performance to be high across almost all categories

# Test out picking

- First round: High stats across many categories, when it's close pick based on `gamesPerYear`
- Third round: What are the gaps from the previous players?
- Position only matters later, once you get the best point-optimizing players

```{r test_run}

picks_01 <- c("Nikola Jokic","Damian Lillard","Devin Booker","Evan Mobley","De'Aaron Fox","Bruce Brown","Kyle Kuzma","Tyrese Maxey","John Collins","","","")
picks_02 <- c("Shai Gilgeous-Alexander","Jaren Jackson Jr.","Cade Cunningham","Victor Wembanyama","Jaden McDaniels","DeMar DeRozan","Scoot Henderson","Ben Simmons","Rudy Gobert","","","")
picks_03 <- c("Kyrie Irving","Al Horford","Donovan Mitchell","Trey Murphy III","Jerami Grant","Brook Lopez","Kelly Olynyk","D'Angelo Russell","Christian Wood","","","")
picks_04 <- c("Luka Doncic","Anthony Davis","Domantas Sabonis","Bradley Beal","Buddy Hield","Derrick White","Michael Porter Jr.","Herbert Jones","Terry Rozier","","","")
picks_05 <- c("Jayson Tatum","James Harden","Pascal Siakam","Fred VanVleet","Bam Adebayo","Draymond Green","Zach LaVine","Tyler Herro","Wendell Carter Jr.","","","")
picks_06 <- c("Karl-Anthony Towns","Andrew Wiggins","Nikola Vucevic","Tobias Harris","P.J. Washington","Nic Claxton","Jusuf Nurkic","Josh Hart","Larry Nance Jr.","","","")
picks_07 <- c("Joel Embiid","Mikal Bridges","LaMelo Ball","Cameron Johnson","Scottie Barnes","Julius Randle","Jalen Brunson","Jarrett Allen","Russell Westbrook","","","")
picks_08 <- c("Tyrese Haliburton","Desmond Bane","OG Anunoby","Lauri Markkanen","Alperen Sengun","Devin Vassell","Darius Garland","Deandre Ayton","Klay Thompson","","","")
picks_09 <- c("Kawhi Leonard","Miles Bridges","Lonzo Ball","Jrue Holiday","Jalen Williams","Otto Porter Jr.","Kevin Porter Jr.","Kevin Huerter","Kevon Looney","","","")
picks_10 <- c("Stephen Curry","Giannis Antetokounmpo","Jaylen Brown","Dejounte Murray","Josh Giddey","Brandon Ingram","Trae Young","Paolo Banchero","","","","")
picks_11 <- c("Kevin Durant","Anthony Edwards","Myles Turner","Jimmy Butler","Keegan Murray","Ja Morant","Jamal Murray","Franz Wagner","","","","")
picks_12 <- c("LeBron James","Kristaps Porzingis","Paul George","Aaron Gordon","CJ McCollum","Kyle Anderson","Chris Paul","Jakob Poeltl","","","","")

picks <- c(picks_01,picks_02,picks_03,picks_04,picks_05,picks_06,picks_07,picks_08,picks_09,picks_10,picks_11,picks_12)

unpicked <- 
  df %>% 
  filter(!player_name %in% picks) %>% 
  arrange(desc(mean_rank)) %>%
  select(player_name,player_pos,mean_rank,trbPerGame:tovPerGame)

teams_picked <-
  df %>%
  filter(player_name %in% picks) %>%
  mutate(
    team = case_when(
      player_name %in% picks_01 ~ "team_01",
      player_name %in% picks_02 ~ "team_02",
      player_name %in% picks_03 ~ "team_03",
      player_name %in% picks_04 ~ "team_04",
      player_name %in% picks_05 ~ "team_05",
      player_name %in% picks_06 ~ "team_06",
      player_name %in% picks_07 ~ "team_07",
      player_name %in% picks_08 ~ "team_08",
      player_name %in% picks_09 ~ "team_09",
      player_name %in% picks_10 ~ "team_10",
      player_name %in% picks_11 ~ "team_11",
      player_name %in% picks_12 ~ "team_12"
    )
  )

team_comp <-
  teams_picked %>%
  group_by(team) %>%
  summarize_at(vars(trbPerGame:tovPerGame), list(~sum(.))) %>%
  pivot_longer(trbPerGame:tovPerGame,names_to = "category") %>% 
  group_by(category) %>%
  mutate(
    rank = cume_dist(value),
    n_teams = n_distinct(team),
    n_beats = rank * n_teams
  )

View(teams_picked); View(team_comp); View(unpicked)

team_comp %>%
  mutate(team = str_remove(team,"^team_")) %>%
  ggplot(aes(x = category, y = n_beats)) +
  facet_grid(vars(team), scales = "free") +
  geom_col() +
  scale_x_discrete(guide = guide_axis(angle = 90)) +
  theme_minimal()

```


```{r}
library(lubridate)

games <-
  arrow::read_parquet("../data/games.parquet") %>%
  filter(yearSeason == 2022) %>%
  select(
    game_id = idGame, game_date = dateGame,  
    player_id = idPlayer, player_name = namePlayer, 
    minutes,pts,fg3m,pctFG,pctFT,ast,treb,stl,blk,tov
  ) %>%
  filter(player_name %in% picks) %>%
  mutate(
    game_week = floor_date(ymd(game_date), unit="week",week_start=1)
  ) %>%
  mutate(
    team = case_when(
      player_name %in% picks_01 ~ "team_01",
      player_name %in% picks_02 ~ "team_02_jub",
      player_name %in% picks_03 ~ "team_03",
      player_name %in% picks_04 ~ "team_04_chad",
      player_name %in% picks_05 ~ "team_05",
      player_name %in% picks_06 ~ "team_06",
      player_name %in% picks_07 ~ "team_07_ezra",
      player_name %in% picks_08 ~ "team_08",
      player_name %in% picks_09 ~ "team_09",
      player_name %in% picks_10 ~ "team_10",
      player_name %in% picks_11 ~ "team_11",
      player_name %in% picks_12 ~ "team_12"
    )
  )


game_weeks <-
  games %>%
  group_by(team, game_week) %>%
  summarize_at(vars(pts:tov),list(~sum(., na.rm = T))) %>%
  pivot_longer(pts:tov, names_to = "stat", values_to = "value")


game_weeks %>%
  ggplot(aes(x = game_week, y = value, color = team)) +
  geom_line() +
  geom_point() +
  facet_grid(vars(stat), scales = "free") +
  paletteer::scale_color_paletteer_d("colorBlindness::paletteMartin") +
  theme_minimal()
```


```{r archive, eval=FALSE, include=FALSE}
picks_01 <- c("Nikola Jokic", "Jimmy Butler","Jaylen Brown","Darius Garland","Myles Turner", "D'Angelo Russell","Steven Adams","","","","","")
picks_02 <- c("Giannis Antetokounmpo", "Fred VanVleet","Scottie Barnes","Zach LaVine", "Evan Mobley", "Michael Porter Jr.","Russell Westbrook","","","","","")
picks_03 <- c("Luka Doncic", "Paul George", "Domantas Sabonis","Rudy Gobert","Terry Rozier","Al Horford","John Wall","","","","","")
picks_04 <- c("LeBron James","Jrue Holiday", "Kristaps Porzingis","Donovan Mitchell","Jonas Valanciunas", "De'Aaron Fox","Jusuf Nurkic","","","","","")
picks_05 <- c("James Harden","Nikola Vucevic","Andrew Wiggins","Wendell Carter Jr.", "DeMar DeRozan", "Jamal Murray","Mitchell Robinson","","","","","")
picks_06 <- c("Karl-Anthony Towns","Dejounte Murray","Mikal Bridges","Damian Lillard", "Jarrett Allen","Clint Capela","Kyle Lowry","Tyrese Maxey","","","","")
picks_07 <- c("Joel Embiid","Devin Booker","CJ McCollum","Tobias Harris","Bradley Beal","Ben Simmons","P.J. Washington","Jordan Poole","","","","")
picks_08 <- c("Jayson Tatum","Anthony Edwards","Desmond Bane","Trae Young", "Robert Williams III","Julius Randle","Dorian Finney-Smith","Victor Oladipo","","","","")
picks_09 <- c("Kevin Durant","LaMelo Ball", "John Collins","Chris Paul","Deandre Ayton","Klay Thompson","Marcus Smart","Onyeka Okongwu","","","","")
picks_10 <- c("Pascal Siakam","Ja Morant", "Khris Middleton","Christian Wood","Kyrie Irving","Kawhi Leonard","Jakob Poeltl","Tyler Herro","","","","")
picks_11 <- c("Anthony Davis","Tyrese Haliburton","Cade Cunningham","OG Anunoby", "Gary Trent Jr.", "Zion Williamson","Gordon Hayward","Malcolm Brogdon", "","","","")
picks_12 <- c("Shai Gilgeous-Alexander","Stephen Curry","Bam Adebayo","Draymond Green", "Brandon Ingram","Kyle Kuzma","Devin Vassell","Collin Sexton","","","","")
```



